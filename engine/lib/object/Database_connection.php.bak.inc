<?php
/*
 * CaMykS Engine
 * Developed by		: camyks.net
 * Author		    : CaMykS Team <camyks.contact@gmail.com>
 * CaMykS Version	: 1.0a
 * Object Version	: 1.0
 * Creation Date	: Jun 2005
 * Last Modif Date  : Sep 2014
 *
 * Database connection object
 */

class Database_connection { 
  /* the database host name */
  var $host;
  /* the database login value */
  var $login;
  /* the database password for the given login */
  var $pwd;
  /* the database name */
  var $name;
  /* the php connection object */
  var $connection;
  /* is database active */
  var $active;
  
  /*
   * object constructor
   * @param string $host the datebase host name
   * @param string $login the database login value
   * @param string $pwd the database password for the given login
   * @param string $driver the driver to use as database connection
   * @return void
   * @access public
   */
  function Database_connection( $host='localhost', $login='root', $pwd='', $driver='' ) {
    $this->host = $host;
    $this->login = $login;
    $this->pwd = $pwd;
    $this->name = null;
    
    /* connect to database */
    $this->connect( );
    
    /* running vars */
    $this->queryRes = null;
  }
  
  /* methods */
  
  /*
   * create connection
   * @return void
   * @access private
   */
  function connect ( ) {
    /* database server connection */
    $this->connection = @mysql_pconnect ( $this->host, $this->login, $this->pwd );
    
    /* check if connection is made successfully */
    if (!$this->connection) {
      $this->active = false;
    } else {
      $this->active = true;
    }
  }
  
  /*
   * select table
   * @param string $name the database name
   * @return boolean
   * @access public
   */
  function select ( $name ) {
    $this->name = $name;
    return mysql_select_db($name ,$this->connection);
  }
  
  /* 
   * kill mysql connnection
   * @return boolean
   * @access public
   */
  function kill() {
    return mysql_close();
  }
	
  /*
   * check if connection is active
   * @return boolean
   * @access public
   */
  function is_active () {
    return $this->active;
  }
  
  /* query related method */
  
  /*
   * execute query
   * @param string $sql
   * @return boolean success
   * @access public
   */
  function execute_query($sql='') {
    $this->queryRes = mysql_query($sql);
    return ($this->queryRes !== false);
  }
  
  /*
   * return id generated by last query
   * @return integer
   * @access public
   */
  function get_queryGeneratedId() {
    return mysql_insert_id();
  }
  
  /*
   * return next query data line
   * @return array
   * @access public
   */
  function get_queryDataLine() {
    return mysql_fetch_assoc($this->queryRes);
  }
  
  /*
   * return latest query error
   * @return string
   * @access public
   */
  function get_queryError() {
    return mysql_error($this->queryRes);
  }
  
  /*
   * return latest query affected rows
   * @return integer
   * @access public
   */
  function get_queryAffectedRows() {
    return mysql_affected_rows($this->queryRes);
  }
  
  
  /* database related methods */
  
  /* 
   * create a database
   * @param string $name
   * @param string $charset
   * @return boolean
   * @access public
   */
  function database_create ( $name, $charset='utf8' ) {
    return mysql_query('CREATE DATABASE '.$name.
		       ' DEFAULT CHARACTER SET '.$charset);
  }

  /*
   * check if a base exits
   * @param string $name
   * @return boolean
   * @access public
   */
  function database_exists ( $name ) {
    return mysql_select_db( $name );
  }

  /*
   * dump database
   * @param mixed $file
   * @return mixed
   * @access public
   */
  function database_dump( $file=false ) {
    if ( !isset($this->name )) {
      return false;
    }
    $content = '';
    
    /* write header comments */
    $content = "-- ************************\n";
    $content .= "-- Database \"".$this->name."\" dump\n";
    $content .= "-- ".date('r')."\n";
    $content .= "-- ************************\n\n";
    
    /* get list of all table */
    $tableRequest = mysql_query('show tables');
    
    /* write tables to content */
    while($table = mysql_fetch_array($tableRequest)) {
      /* write table */
      $createRequest = mysql_query('show create table '.$table[0]);
      if ( $createTable = mysql_fetch_array( $createRequest ) ) {
	
	/* write table comments */
	$content .= "-- ************************\n";
	$content .= "-- Table \"".$table[0]."\"\n";
	$content .= "-- ************************\n";
	
	/* write table creation */
	$content .= $createTable[1].";\n\n";
	
	/* write table content */
	$insertRequest = mysql_query('select * from '.$table[0]);
	while ( $insertData = mysql_fetch_array( $insertRequest ) ){
	  $content .= "insert into ".$table[0]." values(";
	  for($i=0; $i < mysql_num_fields($insertRequest); $i++) {
	    if($i != 0)
	      $content .=  ", ";
	    if(mysql_field_type($insertRequest, $i) == "string" || mysql_field_type($insertRequest, $i) == "blob")
	      $content .=  "'" . addslashes($insertData[$i]) . "'";
	    else
	      $content .= addslashes($insertData[$i]);
	  }
	  $content .=  ");\n"; 
	}
	$content .= "\n\n";
      }
    }
    
    /* write content to file and return file writting result or return content */
    if ( $file !== false ) {
      return file_write ( $file, $content );
    } else {
      return $content;
    }
  }

  /*
   * return database size
   * @return integer
   * @access public
   */
  function database_getSize() {
    /* init size */
    $size = 0;
    
    /* get infos from database */
    if ($result = mysql_query('show table status')) {
      
      /* set size with infos */
      while($data = mysql_fetch_array($result)) {
	    $size += $data[ "Data_length" ] + $data[ "Index_length" ];
      }
      return $size;
    }
    return 0;
  }
}
?>